# Flovyn Rust SDK Development Tasks
# Usage: mise run <task>

[tools]
rust = "stable"

[tasks.build]
description = "Build entire workspace"
run = "cargo build --workspace"

[tasks.test]
description = "Run all tests"
run = "cargo test --workspace"

[tasks."test:unit"]
description = "Run unit tests"
run = "cargo test --test unit -p flovyn-worker-sdk"

[tasks."test:tck"]
description = "Run TCK tests"
run = "cargo test --test tck -p flovyn-worker-sdk"

[tasks."test:e2e"]
description = "Run E2E tests (requires server)"
run = "cargo test --test e2e -p flovyn-worker-sdk -- --ignored --nocapture"

[tasks."test:model"]
description = "Run Stateright model checking tests"
run = "cargo test --test model -p flovyn-worker-sdk"

[tasks.check]
description = "Check code without building"
run = "cargo check --workspace"

[tasks.fmt]
description = "Format code"
run = "cargo fmt --all"

[tasks.clippy]
description = "Run linter"
run = "cargo clippy --workspace --all-targets -- -D warnings"

[tasks.lint]
description = "Run all linting (fmt check + clippy)"
run = """
cargo fmt --all -- --check
cargo clippy --workspace --all-targets -- -D warnings
"""

[tasks.doc]
description = "Build documentation"
run = "cargo doc --no-deps --workspace"

[tasks."example:hello"]
description = "Run hello-world example (DOTENV_PATH=path/to/.env)"
run = "cargo run -p hello-world-sample"

[tasks."example:ecommerce"]
description = "Run ecommerce example (DOTENV_PATH=path/to/.env)"
run = "cargo run -p ecommerce-sample"

[tasks."example:pipeline"]
description = "Run data-pipeline example (DOTENV_PATH=path/to/.env)"
run = "cargo run -p data-pipeline-sample"

[tasks."example:patterns"]
description = "Run patterns example (DOTENV_PATH=path/to/.env)"
run = "cargo run -p patterns-sample"

[tasks."example:standalone"]
description = "Run standalone-tasks example (DOTENV_PATH=path/to/.env)"
run = "cargo run -p standalone-tasks-sample"

[tasks."cleanup:containers"]
description = "Cleanup test containers"
run = "./bin/dev/cleanup-test-containers.sh"

[tasks."model:check"]
description = "Run model checking"
run = "./bin/dev/run-model-check.sh"

[tasks."docker:build"]
description = "Build Docker image for examples (tagged with branch name)"
run = """
BRANCH=$(git rev-parse --abbrev-ref HEAD | sed 's/[^a-zA-Z0-9._-]/-/g')
docker build -t rg.fr-par.scw.cloud/flovyn/rust-examples-worker:${BRANCH} -f examples/Dockerfile .
echo "Built: rg.fr-par.scw.cloud/flovyn/rust-examples-worker:${BRANCH}"
"""

[tasks."docker:run"]
description = "Run example in Docker (EXAMPLE=hello-world)"
run = """
BRANCH=$(git rev-parse --abbrev-ref HEAD | sed 's/[^a-zA-Z0-9._-]/-/g')
docker run --rm -e EXAMPLE=${EXAMPLE:-hello-world} -e FLOVYN_GRPC_SERVER_URL -e FLOVYN_WORKER_TOKEN -e FLOVYN_ORG_ID rg.fr-par.scw.cloud/flovyn/rust-examples-worker:${BRANCH}
"""
