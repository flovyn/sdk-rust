name: Release

on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: "1.82.0"

jobs:
  # Build native libraries for all platforms from a single Linux runner
  build-native:
    name: Build Native Libraries
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install NAPI dependencies
        working-directory: worker-napi
        run: pnpm install

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Add cross-compilation targets
        run: |
          rustup target add x86_64-unknown-linux-gnu
          rustup target add aarch64-unknown-linux-gnu
          rustup target add x86_64-pc-windows-gnu

      - name: Install cargo-cross
        run: cargo install cargo-cross

      # NOTE: macOS cross-compilation disabled - osxcross setup takes 10+ minutes
      # To re-enable, uncomment the following and add targets: x86_64-apple-darwin, aarch64-apple-darwin
      # - name: Setup osxcross for macOS cross-compilation
      #   uses: Timmmm/setup-osxcross@v3
      #   with:
      #     osx-version: "14.5"

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: release-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            release-cargo-

      # Build for all targets using cargo-cross for cross-compilation
      - name: Build Linux x86_64
        run: cargo build -p flovyn-worker-ffi --release --target x86_64-unknown-linux-gnu

      - name: Build Linux aarch64
        run: cargo cross build -p flovyn-worker-ffi --release --target aarch64-unknown-linux-gnu

      # NOTE: macOS builds disabled - osxcross setup takes 10+ minutes
      # - name: Build macOS x86_64
      #   run: cargo cross build -p flovyn-worker-ffi --release --target x86_64-apple-darwin
      #
      # - name: Build macOS aarch64
      #   run: cargo cross build -p flovyn-worker-ffi --release --target aarch64-apple-darwin

      - name: Build Windows x86_64
        run: cargo cross build -p flovyn-worker-ffi --release --target x86_64-pc-windows-gnu

      # NOTE: Windows ARM64 disabled - needs native runner or manual llvm-mingw setup
      # - name: Build Windows ARM64
      #   run: cargo cross build -p flovyn-worker-ffi --release --target aarch64-pc-windows-gnullvm

      # Build NAPI modules for TypeScript SDK
      - name: Build NAPI Linux x86_64
        working-directory: worker-napi
        run: pnpm build --target x86_64-unknown-linux-gnu

      - name: Build NAPI Linux aarch64
        working-directory: worker-napi
        run: pnpm build --target aarch64-unknown-linux-gnu
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      # NOTE: macOS and Windows NAPI builds disabled - require native runners
      # - name: Build NAPI macOS x86_64
      #   working-directory: worker-napi
      #   run: pnpm build --target x86_64-apple-darwin
      # - name: Build NAPI macOS aarch64
      #   working-directory: worker-napi
      #   run: pnpm build --target aarch64-apple-darwin
      # - name: Build NAPI Windows x86_64
      #   working-directory: worker-napi
      #   run: pnpm build --target x86_64-pc-windows-msvc

      # Generate language bindings
      - name: Generate Kotlin bindings
        run: |
          mkdir -p bindings/kotlin
          cargo run -p flovyn-worker-ffi --bin uniffi-bindgen -- \
            generate --library target/x86_64-unknown-linux-gnu/release/libflovyn_worker_ffi.so \
            --language kotlin \
            --out-dir bindings/kotlin

      - name: Generate Python bindings
        run: |
          mkdir -p bindings/python
          cargo run -p flovyn-worker-ffi --bin uniffi-bindgen -- \
            generate --library target/x86_64-unknown-linux-gnu/release/libflovyn_worker_ffi.so \
            --language python \
            --out-dir bindings/python

      # Package artifacts
      - name: Package native libraries
        run: |
          mkdir -p artifacts/natives/{linux-x86_64,linux-aarch64,windows-x86_64}

          cp target/x86_64-unknown-linux-gnu/release/libflovyn_worker_ffi.so \
             artifacts/natives/linux-x86_64/

          cp target/aarch64-unknown-linux-gnu/release/libflovyn_worker_ffi.so \
             artifacts/natives/linux-aarch64/

          # NOTE: macOS disabled
          # cp target/x86_64-apple-darwin/release/libflovyn_worker_ffi.dylib \
          #    artifacts/natives/macos-x86_64/
          # cp target/aarch64-apple-darwin/release/libflovyn_worker_ffi.dylib \
          #    artifacts/natives/macos-aarch64/

          cp target/x86_64-pc-windows-gnu/release/flovyn_worker_ffi.dll \
             artifacts/natives/windows-x86_64/

          # NOTE: Windows ARM64 disabled
          # cp target/aarch64-pc-windows-gnullvm/release/flovyn_worker_ffi.dll \
          #    artifacts/natives/windows-aarch64/

          # Copy bindings
          cp -r bindings artifacts/

          # Create combined archive for easy download
          cd artifacts
          tar -czvf flovyn-worker-ffi-${{ github.ref_name }}.tar.gz natives bindings

      - name: Upload native libraries artifact
        uses: actions/upload-artifact@v4
        with:
          name: flovyn-worker-ffi-natives
          path: artifacts/natives/

      - name: Upload bindings artifact
        uses: actions/upload-artifact@v4
        with:
          name: flovyn-worker-ffi-bindings
          path: artifacts/bindings/

      - name: Upload combined archive
        uses: actions/upload-artifact@v4
        with:
          name: flovyn-worker-ffi-release
          path: artifacts/flovyn-worker-ffi-${{ github.ref_name }}.tar.gz

      - name: Upload NAPI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: napi-artifacts
          path: worker-napi/*.node

      - name: Upload TypeScript definitions
        uses: actions/upload-artifact@v4
        with:
          name: napi-types
          path: |
            worker-napi/index.d.ts
            worker-napi/index.js

  # Validate the release
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Build
        run: cargo build --workspace --release

      - name: Run tests
        run: cargo test --workspace --release

  # Publish to crates.io (optional)
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: [validate, build-native]

    steps:
      - uses: actions/checkout@v4

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Publish flovyn-worker-core (dry-run)
        run: cargo publish -p flovyn-worker-core --dry-run

      - name: Publish flovyn-worker-sdk (dry-run)
        run: cargo publish -p flovyn-worker-sdk --dry-run

      # Uncomment when ready to publish
      # - name: Publish flovyn-worker-core
      #   run: cargo publish -p flovyn-worker-core
      #   env:
      #     CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      #
      # - name: Publish flovyn-worker-sdk
      #   run: cargo publish -p flovyn-worker-sdk
      #   env:
      #     CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # Create GitHub Release with native library artifacts
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, build-native]
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download native libraries
        uses: actions/download-artifact@v4
        with:
          name: flovyn-worker-ffi-natives
          path: natives/

      - name: Download bindings
        uses: actions/download-artifact@v4
        with:
          name: flovyn-worker-ffi-bindings
          path: bindings/

      - name: Download combined archive
        uses: actions/download-artifact@v4
        with:
          name: flovyn-worker-ffi-release
          path: ./

      - name: Download NAPI artifacts
        uses: actions/download-artifact@v4
        with:
          name: napi-artifacts
          path: napi-artifacts/

      # Create individual platform archives for direct download
      - name: Package individual platform archives
        run: |
          cd natives
          for platform in linux-x86_64 linux-aarch64 windows-x86_64; do
            tar -czvf ../libflovyn_worker_ffi-${platform}.tar.gz ${platform}/
          done
          cd ../bindings
          tar -czvf ../flovyn-worker-ffi-bindings.tar.gz .

      - name: Package NAPI artifacts
        run: |
          cd napi-artifacts
          tar -czvf ../flovyn-worker-napi-linux.tar.gz .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          files: |
            flovyn-worker-ffi-${{ github.ref_name }}.tar.gz
            libflovyn_worker_ffi-linux-x86_64.tar.gz
            libflovyn_worker_ffi-linux-aarch64.tar.gz
            libflovyn_worker_ffi-windows-x86_64.tar.gz
            flovyn-worker-ffi-bindings.tar.gz
            flovyn-worker-napi-linux.tar.gz
