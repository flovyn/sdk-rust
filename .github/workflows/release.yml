name: Release

on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always
  RUST_VERSION: "1.82.0"

jobs:
  # Build native libraries in parallel using matrix
  build-native:
    name: Build (${{ matrix.platform.name }})
    runs-on: ${{ matrix.platform.runner }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        platform:
          - name: linux-x86_64
            runner: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            use_cross: false
            build_napi: true
            ffi_artifact: libflovyn_worker_ffi.so
          - name: linux-aarch64
            runner: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            use_cross: true
            build_napi: true
            ffi_artifact: libflovyn_worker_ffi.so
            linker: aarch64-linux-gnu-gcc
          # - name: macos-x86_64
          #   runner: macos-13
          #   target: x86_64-apple-darwin
          #   use_cross: false
          #   build_napi: true
          #   ffi_artifact: libflovyn_worker_ffi.dylib
          - name: macos-aarch64
            runner: macos-latest
            target: aarch64-apple-darwin
            use_cross: false
            build_napi: true
            ffi_artifact: libflovyn_worker_ffi.dylib
          - name: windows-x86_64
            runner: ubuntu-latest
            target: x86_64-pc-windows-gnu
            use_cross: true
            build_napi: false  # Windows NAPI requires native MSVC runner
            ffi_artifact: flovyn_worker_ffi.dll

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          if [ "${{ matrix.platform.target }}" = "aarch64-unknown-linux-gnu" ]; then
            sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          fi

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install protobuf

      - name: Setup Node.js
        if: matrix.platform.build_napi
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        if: matrix.platform.build_napi
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install NAPI dependencies
        if: matrix.platform.build_napi
        working-directory: worker-napi
        run: pnpm install

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: ${{ matrix.platform.target }}

      - name: Install cargo-cross
        if: matrix.platform.use_cross
        run: cargo install cargo-cross

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: release-cargo-${{ runner.os }}-${{ matrix.platform.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            release-cargo-${{ runner.os }}-${{ matrix.platform.target }}-

      - name: Build FFI
        run: |
          if [ "${{ matrix.platform.use_cross }}" = "true" ]; then
            cargo cross build -p flovyn-worker-ffi --release --target ${{ matrix.platform.target }}
          else
            cargo build -p flovyn-worker-ffi --release --target ${{ matrix.platform.target }}
          fi

      - name: Build NAPI
        if: matrix.platform.build_napi
        working-directory: worker-napi
        run: pnpm build --target ${{ matrix.platform.target }}
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: ${{ matrix.platform.linker }}

      - name: Upload FFI artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffi-${{ matrix.platform.name }}
          path: target/${{ matrix.platform.target }}/release/${{ matrix.platform.ffi_artifact }}

      - name: Upload NAPI artifact
        if: matrix.platform.build_napi
        uses: actions/upload-artifact@v4
        with:
          name: napi-${{ matrix.platform.name }}
          path: worker-napi/*.node

      - name: Upload TypeScript definitions
        if: matrix.platform.name == 'linux-x86_64'
        uses: actions/upload-artifact@v4
        with:
          name: napi-types
          path: |
            worker-napi/index.d.ts
            worker-napi/index.js

  # Generate bindings and package all artifacts
  package:
    name: Package Artifacts
    runs-on: ubuntu-latest
    needs: build-native
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Download all FFI artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ffi-*
          path: ffi-artifacts/

      - name: Download all NAPI artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: napi-*
          path: napi-artifacts/
          merge-multiple: false

      # Generate language bindings using the linux-x86_64 .so
      - name: Generate Kotlin bindings
        run: |
          mkdir -p bindings/kotlin
          cargo run -p flovyn-worker-ffi --bin uniffi-bindgen -- \
            generate --library ffi-artifacts/ffi-linux-x86_64/libflovyn_worker_ffi.so \
            --language kotlin \
            --out-dir bindings/kotlin

      - name: Generate Python bindings
        run: |
          mkdir -p bindings/python
          cargo run -p flovyn-worker-ffi --bin uniffi-bindgen -- \
            generate --library ffi-artifacts/ffi-linux-x86_64/libflovyn_worker_ffi.so \
            --language python \
            --out-dir bindings/python

      # Package all artifacts
      - name: Package artifacts
        run: |
          mkdir -p artifacts/natives/{linux-x86_64,linux-aarch64,macos-x86_64,macos-aarch64,windows-x86_64}

          cp ffi-artifacts/ffi-linux-x86_64/libflovyn_worker_ffi.so artifacts/natives/linux-x86_64/
          cp ffi-artifacts/ffi-linux-aarch64/libflovyn_worker_ffi.so artifacts/natives/linux-aarch64/
          cp ffi-artifacts/ffi-macos-x86_64/libflovyn_worker_ffi.dylib artifacts/natives/macos-x86_64/
          cp ffi-artifacts/ffi-macos-aarch64/libflovyn_worker_ffi.dylib artifacts/natives/macos-aarch64/
          cp ffi-artifacts/ffi-windows-x86_64/flovyn_worker_ffi.dll artifacts/natives/windows-x86_64/

          cp -r bindings artifacts/

          cd artifacts
          tar -czvf flovyn-worker-ffi-${{ github.ref_name }}.tar.gz natives bindings

      - name: Upload packaged natives
        uses: actions/upload-artifact@v4
        with:
          name: flovyn-worker-ffi-natives
          path: artifacts/natives/

      - name: Upload bindings
        uses: actions/upload-artifact@v4
        with:
          name: flovyn-worker-ffi-bindings
          path: artifacts/bindings/

      - name: Upload combined archive
        uses: actions/upload-artifact@v4
        with:
          name: flovyn-worker-ffi-release
          path: artifacts/flovyn-worker-ffi-${{ github.ref_name }}.tar.gz

  # Validate the release
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Build
        run: cargo build --workspace --release

      - name: Run tests
        run: cargo test --workspace --release

  # Publish to crates.io (optional)
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    needs: [validate, package]

    steps:
      - uses: actions/checkout@v4

      - name: Install protoc
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Publish flovyn-worker-core (dry-run)
        run: cargo publish -p flovyn-worker-core --dry-run

      - name: Publish flovyn-worker-sdk (dry-run)
        run: cargo publish -p flovyn-worker-sdk --dry-run

      # Uncomment when ready to publish
      # - name: Publish flovyn-worker-core
      #   run: cargo publish -p flovyn-worker-core
      #   env:
      #     CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
      #
      # - name: Publish flovyn-worker-sdk
      #   run: cargo publish -p flovyn-worker-sdk
      #   env:
      #     CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # Create GitHub Release with native library artifacts
  github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, package]
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download packaged natives
        uses: actions/download-artifact@v4
        with:
          name: flovyn-worker-ffi-natives
          path: natives/

      - name: Download bindings
        uses: actions/download-artifact@v4
        with:
          name: flovyn-worker-ffi-bindings
          path: bindings/

      - name: Download combined archive
        uses: actions/download-artifact@v4
        with:
          name: flovyn-worker-ffi-release
          path: ./

      - name: Download NAPI artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: napi-*
          path: napi-artifacts/
          merge-multiple: false

      # Create individual platform archives
      - name: Package individual platform archives
        run: |
          cd natives
          for platform in linux-x86_64 linux-aarch64 macos-x86_64 macos-aarch64 windows-x86_64; do
            tar -czvf ../libflovyn_worker_ffi-${platform}.tar.gz ${platform}/
          done
          cd ../bindings
          tar -czvf ../flovyn-worker-ffi-bindings.tar.gz .

      - name: Package NAPI artifacts
        run: |
          # Create per-platform NAPI archives with expected names
          # napi-linux-x86_64 -> linux-x64-gnu
          if [ -d "napi-artifacts/napi-linux-x86_64" ]; then
            tar -czvf flovyn-worker-napi-linux-x64-gnu.tar.gz -C napi-artifacts/napi-linux-x86_64 .
          fi
          # napi-linux-aarch64 -> linux-arm64-gnu
          if [ -d "napi-artifacts/napi-linux-aarch64" ]; then
            tar -czvf flovyn-worker-napi-linux-arm64-gnu.tar.gz -C napi-artifacts/napi-linux-aarch64 .
          fi
          # napi-macos-x86_64 -> darwin-x64
          if [ -d "napi-artifacts/napi-macos-x86_64" ]; then
            tar -czvf flovyn-worker-napi-darwin-x64.tar.gz -C napi-artifacts/napi-macos-x86_64 .
          fi
          # napi-macos-aarch64 -> darwin-arm64
          if [ -d "napi-artifacts/napi-macos-aarch64" ]; then
            tar -czvf flovyn-worker-napi-darwin-arm64.tar.gz -C napi-artifacts/napi-macos-aarch64 .
          fi
          # Copy type definitions
          if [ -d "napi-artifacts/napi-types" ]; then
            tar -czvf flovyn-worker-napi-types.tar.gz -C napi-artifacts/napi-types .
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          files: |
            flovyn-worker-ffi-${{ github.ref_name }}.tar.gz
            libflovyn_worker_ffi-linux-x86_64.tar.gz
            libflovyn_worker_ffi-linux-aarch64.tar.gz
            libflovyn_worker_ffi-macos-x86_64.tar.gz
            libflovyn_worker_ffi-macos-aarch64.tar.gz
            libflovyn_worker_ffi-windows-x86_64.tar.gz
            flovyn-worker-ffi-bindings.tar.gz
            flovyn-worker-napi-linux-x64-gnu.tar.gz
            flovyn-worker-napi-linux-arm64-gnu.tar.gz
            flovyn-worker-napi-darwin-x64.tar.gz
            flovyn-worker-napi-darwin-arm64.tar.gz
            flovyn-worker-napi-types.tar.gz
